<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sprite Sheet Slicer - NOCRACY</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #F4F1E8;
      color: #2C2416;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    h1 {
      margin-bottom: 10px;
      color: #2A74B8;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #FAF9F6;
      border-radius: 6px;
      border: 1px solid #E5E0D6;
    }
    
    .section h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #2C2416;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #2C2416;
    }
    
    input[type="file"],
    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #D4C5B0;
      border-radius: 4px;
      font-size: 14px;
      background: white;
    }
    
    input[type="file"] {
      padding: 8px;
    }
    
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    button {
      background: #2A74B8;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    button:hover {
      background: #1E5A8A;
    }
    
    button:disabled {
      background: #CCC;
      cursor: not-allowed;
    }
    
    .preview {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border: 1px solid #D4C5B0;
      border-radius: 4px;
    }
    
    .preview img {
      max-width: 100%;
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
    }
    
    .grid-preview {
      display: grid;
      gap: 2px;
      margin-top: 15px;
      padding: 10px;
      background: #E5E0D6;
      border-radius: 4px;
    }
    
    .tile-preview {
      background: white;
      border: 1px solid #D4C5B0;
      image-rendering: pixelated;
    }
    
    .output {
      margin-top: 20px;
      padding: 15px;
      background: #2C2416;
      color: #F4F1E8;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
    
    .download-btn {
      margin-top: 10px;
      background: #2E8B57;
    }
    
    .download-btn:hover {
      background: #246B44;
    }
    
    .info {
      margin-top: 10px;
      padding: 10px;
      background: #E8F4F8;
      border-left: 3px solid #2A74B8;
      border-radius: 4px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé® Sprite Sheet Slicer</h1>
    <p class="subtitle">–ù–∞—Ä–µ–∂—å—Ç–µ PNG —Å–ø—Ä–∞–π—Ç-–ª–∏—Å—Ç –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–∞–π–ª—ã</p>
    
    <div class="section">
      <h2>1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–ø—Ä–∞–π—Ç-–ª–∏—Å—Ç</h2>
      <input type="file" id="fileInput" accept="image/png,image/jpeg" />
      <div id="fileInfo" class="info" style="display: none;"></div>
    </div>
    
    <div class="section">
      <h2>2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞—Ä–µ–∑–∫–∏</h2>
      <div class="row">
        <div>
          <label for="tileSize">–†–∞–∑–º–µ—Ä —Ç–∞–π–ª–∞ (–ø–∏–∫—Å–µ–ª–∏):</label>
          <input type="number" id="tileSize" value="16" min="1" max="256" />
        </div>
        <div>
          <label for="prefix">–ü—Ä–µ—Ñ–∏–∫—Å –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞:</label>
          <input type="text" id="prefix" value="tile" />
        </div>
      </div>
    </div>
    
    <div class="section">
      <h2>3. –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h2>
      <div id="preview" class="preview" style="display: none;">
        <div id="imagePreview"></div>
        <div id="gridPreview" class="grid-preview"></div>
      </div>
    </div>
    
    <div class="section">
      <h2>4. –ù–∞—Ä–µ–∑–∞—Ç—å –∏ —Å–∫–∞—á–∞—Ç—å</h2>
      <button id="sliceBtn" disabled>–ù–∞—Ä–µ–∑–∞—Ç—å —Å–ø—Ä–∞–π—Ç—ã</button>
      <div id="output" class="output" style="display: none;"></div>
      <button id="downloadBtn" class="download-btn" style="display: none;">–°–∫–∞—á–∞—Ç—å ZIP –∞—Ä—Ö–∏–≤</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    const fileInput = document.getElementById('fileInput');
    const tileSizeInput = document.getElementById('tileSize');
    const prefixInput = document.getElementById('prefix');
    const sliceBtn = document.getElementById('sliceBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const fileInfo = document.getElementById('fileInfo');
    const preview = document.getElementById('preview');
    const imagePreview = document.getElementById('imagePreview');
    const gridPreview = document.getElementById('gridPreview');
    const output = document.getElementById('output');
    
    let currentImage = null;
    let tiles = [];
    
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          currentImage = img;
          fileInfo.style.display = 'block';
          fileInfo.innerHTML = `
            <strong>–§–∞–π–ª:</strong> ${file.name}<br>
            <strong>–†–∞–∑–º–µ—Ä:</strong> ${img.width} √ó ${img.height} –ø–∏–∫—Å–µ–ª–µ–π<br>
            <strong>–¢–∞–π–ª–æ–≤:</strong> ${Math.floor(img.width / parseInt(tileSizeInput.value))} √ó ${Math.floor(img.height / parseInt(tileSizeInput.value))}
          `;
          updatePreview();
          sliceBtn.disabled = false;
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });
    
    tileSizeInput.addEventListener('input', () => {
      if (currentImage) {
        updatePreview();
      }
    });
    
    function updatePreview() {
      if (!currentImage) return;
      
      const tileSize = parseInt(tileSizeInput.value);
      const cols = Math.floor(currentImage.width / tileSize);
      const rows = Math.floor(currentImage.height / tileSize);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      imagePreview.innerHTML = `
        <img src="${currentImage.src}" alt="Original" style="max-width: 100%;" />
        <p style="margin-top: 10px; font-size: 12px; color: #666;">
          –°–µ—Ç–∫–∞: ${cols} √ó ${rows} —Ç–∞–π–ª–æ–≤
        </p>
      `;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ—Ç–∫—É —Ç–∞–π–ª–æ–≤
      gridPreview.style.gridTemplateColumns = `repeat(${Math.min(cols, 10)}, 1fr)`;
      gridPreview.innerHTML = '';
      
      const previewCount = Math.min(cols * rows, 50); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º—É–º 50 —Ç–∞–π–ª–æ–≤ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
      for (let i = 0; i < previewCount; i++) {
        const row = Math.floor(i / cols);
        const col = i % cols;
        const x = col * tileSize;
        const y = row * tileSize;
        
        const canvas = document.createElement('canvas');
        canvas.width = tileSize;
        canvas.height = tileSize;
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;
        ctx.drawImage(currentImage, x, y, tileSize, tileSize, 0, 0, tileSize, tileSize);
        
        const tileDiv = document.createElement('div');
        tileDiv.className = 'tile-preview';
        tileDiv.style.width = `${tileSize * 2}px`;
        tileDiv.style.height = `${tileSize * 2}px`;
        tileDiv.style.backgroundImage = `url(${canvas.toDataURL()})`;
        tileDiv.style.backgroundSize = `${tileSize * 2}px ${tileSize * 2}px`;
        tileDiv.style.imageRendering = 'pixelated';
        gridPreview.appendChild(tileDiv);
      }
      
      if (previewCount < cols * rows) {
        const moreDiv = document.createElement('div');
        moreDiv.style.gridColumn = 'span 10';
        moreDiv.style.textAlign = 'center';
        moreDiv.style.padding = '10px';
        moreDiv.style.color = '#666';
        moreDiv.textContent = `... –∏ –µ—â–µ ${cols * rows - previewCount} —Ç–∞–π–ª–æ–≤`;
        gridPreview.appendChild(moreDiv);
      }
      
      preview.style.display = 'block';
    }
    
    sliceBtn.addEventListener('click', async () => {
      if (!currentImage) return;
      
      sliceBtn.disabled = true;
      sliceBtn.textContent = '–ù–∞—Ä–µ–∑–∞—é...';
      
      const tileSize = parseInt(tileSizeInput.value);
      const prefix = prefixInput.value || 'tile';
      const cols = Math.floor(currentImage.width / tileSize);
      const rows = Math.floor(currentImage.height / tileSize);
      
      tiles = [];
      const tileMap = {};
      const zip = new JSZip();
      
      // –°–æ–∑–¥–∞–µ–º canvas –¥–ª—è –Ω–∞—Ä–µ–∑–∫–∏
      const canvas = document.createElement('canvas');
      canvas.width = tileSize;
      canvas.height = tileSize;
      const ctx = canvas.getContext('2d');
      ctx.imageSmoothingEnabled = false;
      
      // –ù–∞—Ä–µ–∑–∞–µ–º —Ç–∞–π–ª—ã
      for (let row = 0; row < rows; row++) {
        for (let col = 0; col < cols; col++) {
          const x = col * tileSize;
          const y = row * tileSize;
          
          // –û—á–∏—â–∞–µ–º canvas
          ctx.clearRect(0, 0, tileSize, tileSize);
          
          // –ö–æ–ø–∏—Ä—É–µ–º —á–∞—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
          ctx.drawImage(
            currentImage,
            x, y, tileSize, tileSize,
            0, 0, tileSize, tileSize
          );
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ ZIP
          const tileName = `${prefix}_${row}_${col}.png`;
          const dataUrl = canvas.toDataURL('image/png');
          const base64 = dataUrl.split(',')[1];
          zip.file(tileName, base64, { base64: true });
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
          const key = `${prefix}_${row}_${col}`;
          tileMap[key] = [x, y];
          
          tiles.push({ name: tileName, x, y, row, col });
        }
      }
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º JSON —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
      const jsonData = {
        tileSize,
        spritesheet: {
          width: currentImage.width,
          height: currentImage.height,
          cols,
          rows,
        },
        tiles: tileMap,
        typescript: Object.entries(tileMap)
          .map(([key, [x, y]]) => `  ${key}: [${x}, ${y}],`)
          .join('\n'),
      };
      
      zip.file('tilemap.json', JSON.stringify(jsonData, null, 2));
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º TypeScript –∫–æ–¥ –¥–ª—è pixelholeMap.ts
      const tsCode = `// Auto-generated tile mapping
export const TILEMAP: Record<string, [number, number]> = {
${Object.entries(tileMap)
  .map(([key, [x, y]]) => `  ${key}: [${x}, ${y}],`)
  .join('\n')}
};`;
      
      zip.file('tilemap.ts', tsCode);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      output.style.display = 'block';
      output.textContent = `‚úì –ù–∞—Ä–µ–∑–∞–Ω–æ ${tiles.length} —Ç–∞–π–ª–æ–≤\n\n–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è pixelholeMap.ts:\n\n${tsCode}`;
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º ZIP –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
      const blob = await zip.generateAsync({ type: 'blob' });
      const url = URL.createObjectURL(blob);
      downloadBtn.style.display = 'block';
      downloadBtn.onclick = () => {
        const a = document.createElement('a');
        a.href = url;
        a.download = `${prefix}_tiles.zip`;
        a.click();
      };
      
      sliceBtn.disabled = false;
      sliceBtn.textContent = '–ù–∞—Ä–µ–∑–∞—Ç—å —Å–ø—Ä–∞–π—Ç—ã';
    });
  </script>
</body>
</html>
